#SPDX-License-Identifier: MIT-0
---
# tasks file for ./ansible-role-gaming

# =============================================================================
# Network Connectivity Check
# =============================================================================

- name: Wait for network connectivity before package installation
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 archlinux.org
  register: network_check
  until: network_check.rc == 0
  retries: 30
  delay: 2
  changed_when: false
  tags:
    - gaming
    - network
    - packages

# =============================================================================
# Package Installation
# =============================================================================

- name: Install gaming packages
  community.general.pacman:
    name: "{{ gaming_packages }}"
    state: present
    extra_args: '--noconfirm --needed'
  register: gaming_install_result
  tags:
    - gaming
    - packages

# =============================================================================
# File Configuration
# =============================================================================

- name: Copy game.conf to limits.d
  ansible.builtin.copy:
    src: game.conf
    dest: "{{ gaming_limits_conf_dest }}"
    owner: root
    group: root
    mode: '0644'
  register: game_conf_result
  tags:
    - gaming
    - config

- name: Copy game script to /usr/local/bin
  ansible.builtin.copy:
    src: game
    dest: "{{ gaming_script_dest }}"
    owner: root
    group: root
    mode: '0755'
  register: game_script_result
  tags:
    - gaming
    - config

# =============================================================================
# Verification
# =============================================================================

- name: Verify gaming packages are installed
  ansible.builtin.command:
    cmd: "pacman -Q {{ item }}"
  loop: "{{ gaming_packages }}"
  register: package_verify
  changed_when: false
  failed_when: package_verify.rc != 0
  tags:
    - gaming
    - verify

- name: Verify game.conf exists
  ansible.builtin.stat:
    path: "{{ gaming_limits_conf_dest }}"
  register: game_conf_stat
  tags:
    - gaming
    - verify

- name: Assert game.conf was copied
  ansible.builtin.assert:
    that:
      - game_conf_stat.stat.exists
      - game_conf_stat.stat.mode == '0644'
    fail_msg: "game.conf was not copied correctly"
  tags:
    - gaming
    - verify

- name: Verify game script exists and is executable
  ansible.builtin.stat:
    path: "{{ gaming_script_dest }}"
  register: game_script_stat
  tags:
    - gaming
    - verify

- name: Assert game script was copied and is executable
  ansible.builtin.assert:
    that:
      - game_script_stat.stat.exists
      - game_script_stat.stat.executable
      - game_script_stat.stat.mode == '0755'
    fail_msg: "game script was not copied or is not executable"
  tags:
    - gaming
    - verify

- name: Display installation summary
  ansible.builtin.debug:
    msg: |
      Gaming Installation Summary:
      ============================
      Packages installed: {{ gaming_install_result is success }}
      game.conf copied: {{ game_conf_result is success }} -> {{ gaming_limits_conf_dest }}
      game script copied: {{ game_script_result is success }} -> {{ gaming_script_dest }}
      game script executable: {{ game_script_stat.stat.executable }}
  tags:
    - gaming
    - verify
